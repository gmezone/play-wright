var WebBlender=function(n){var r=[],c,l=function(n){var t=n.originalEvent||n,u,i;if(t&&t.data&&JSON.parse)try{u=JSON.parse(t.data);u.message==="ready"&&clearTimeout(c)}catch(f){}for(i=0;i<r.length;i++)r[i](t)};n(window).on("message",l);var u,e=function(t,i,r,u){var e=t&&t.toLowerCase&&t.toLowerCase()||"",f;switch(e){case"dev":f="cliblends.dev.microsoft.com";break;case"int":f="uniblends.www.microsoft.com/int";break;case"ppe":f="uniblends.www.microsoft.com/ppe";break;case"prod":default:f="www.microsoft.com/uniblends"}return"https://{host}/{client}{deviceFamily}{flight}".replace("{host}",f).replace("{client}",i&&n.trim(i)?"?client="+i:"?client=").replace("{deviceFamily}",u&&n.trim(u)?"&deviceFamily="+n.trim(u):"").replace("{flight}",r&&n.trim(r)?"&setflight="+n.trim(r):"")},a=function(t,i,r){var f=t&&t.toLowerCase&&t.toLowerCase()||"",u;switch(f){case"dev":u="oneblend.dev.microsoft.com";break;case"int":u="unistoreblends-int.www.microsoft.com";break;case"ppe":u="unistoreblends-ppe.www.microsoft.com";break;default:u="www.microsoft.com"}return"https://{host}/webblend/api/config{client}{flight}".replace("{host}",u).replace("{client}",i&&n.trim(i)?"?client="+i:"").replace("{flight}",r&&n.trim(r)?(i&&n.trim(i)?"&setflight=":"?setflight=")+r:"")},v=function(n,t){var r=n&&n.toLowerCase&&n.toLowerCase()||"",i;switch(r){case"dev":case"int":i="purchase-int.mp.microsoft.com";break;default:i="purchase.mp.microsoft.com"}return"https://{host}/{purchaseServiceVersion}/users/me/orders".replace("{host}",i).replace("{purchaseServiceVersion}",t==7?"v7.0":"v6.0")},o=function(){function n(){return Math.floor(Math.random()*16).toString(16)}var t="xxxxxxxx-xxxx-4xxx-Rxxx-xxxxxxxxxxxx".replace(/x/g,n);return t.replace("R",(8|Math.floor(Math.random()*3)).toString(16))},s=function(t,i){var u="wb_auto_blend_container",r=n("#"+u),f=i&&i.width||"456px",e=i&&i.height||"560px";return r.length?r.css({height:e,width:f}):(r=n("<iframe />",{id:u,name:u,src:"",style:"width:{width}; height:{height}; position:relative; top:0; left:0; border:0; outline:none; display:block".replace("{width}",f).replace("{height}",e)}),r.appendTo(t)),r},ft=function(n,t){var i=document&&document.cookie&&document.cookie.indexOf(t)>-1,u,r;if(!i)for(u=n&&n.split(",")||[],r=0;!i&&r<u.length;r++)u[r]===t&&(i=!0);return i},y=function(n,t){var i=document.getElementById(n);i.contentWindow.postMessage(JSON.stringify({startdata:t}),"*")},t=function(t,i,r,f,o,h,c,l){var p,v,b,k,d,w,g,nt,tt;u=n("#"+i);p=(new Date).getTime();v=s(u,c);v.attr("src","");b="wb_auto_blend_container";t.Client=o;t.configUrl=a(r,o,f);k=h.substr(2).replace("/",".");t.selApps=k;g=e(r,o,f,l);v.attr("src",g);d=(new Date).getTime();w=d-p;v.one("load",function(){w&&window.postMessage(JSON.stringify({message:"status",data:"blenderSDK: blender iframe loaded in "+w+"ms"}),"*");y(b,t)});nt=(new Date).getTime();tt=nt-p;window.postMessage(JSON.stringify({message:"status",data:"blenderSDK: Loaded in "+tt+"ms"}),"*")},i=function(n,t){t&&(n.Layout=t.layout||"",n.CssOverride=t.cssOverride||"")},p=function(t){if(t){u=n("#"+t.ParentElementId);var i=s(u,{height:0,width:0}),r=e(t.Environment,t.ClientType,t.Flight,t.DeviceFamily);i.attr("src",r);window.postMessage(JSON.stringify({message:"status",data:"blenderSDK: Preload started"}),"*")}},h=function(n){var r={};n&&(r.AvailabilityId=n.AvailabilityId||"",r.ProductId=n.ProductId||"",r.SkuId=n.SkuId||"",r.Quantity=n.Quantity||1,r.Auth=n.Auth||"",r.XToken=n.XToken||"",r.Culture=n.Culture||"",r.Market=n.Market||"",r.CV=n.CV||"",r.IdentityType=n.IdentityType,r.IdentityValue=n.IdentityValue,r.PurchaseServiceVersion=n.PurchaseServiceVersion||"",r.useDelegatedAuth=n.UseDelegatedAuth||!1,r.OrderId=n.OrderId,r.Order=n.Order,r.Jwt=n.Jwt,r.Product=n.Product,r.TestClient=n.TestClient||"",r.DeviceContext="moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC",n.Options&&(r.CampaignId=n.Options.CampaignId||"",r.OptionalCampaignId=n.Options.OptionalCampaignId||"",r.OfferType=n.Options.OfferType||"",r.AddPiSuccessUrl=n.Options.AddPiSuccessUrl||"",r.AddPiFailureUrl=n.Options.AddPiFailureUrl||""),n.MediaOptions&&(r.ProductType=n.MediaOptions.ProductType||"",r.TransactionType=n.MediaOptions.TransactionType||"buy",r.Title=n.MediaOptions.Title||"",r.TitleNo=n.MediaOptions.TitleNo||"",r.SubTitle1=n.MediaOptions.SubTitle1||"",r.SubTitle2=n.MediaOptions.SubTitle2||"",r.ExpirationBeforePlayInHours=n.MediaOptions.ExpirationBeforePlayInHours||"",r.ExpirationAfterPlayInHours=n.MediaOptions.ExpirationAfterPlayInHours||""),n.BeneficiaryData&&(r.BeneficiaryEmail=n.BeneficiaryData.email,r.BeneficiaryFirstName=n.BeneficiaryData.firstName||"",r.BeneficiaryLastName=n.BeneficiaryData.lastName||""),i(r,n.Style),t(r,n.ParentElementId,n.Environment,n.Flight,n.ClientType,"#/purchase/confirm",n.IframeOptions,n.DeviceFamily||""))},w=function(t){var i={billingInformation:null,clientContext:{client:t.ClientType,deviceId:t.DeviceId,deviceType:t.DeviceFamily},friendlyName:null,items:[{availabilityId:t.AvailabilityId,beneficiary:t.IdentityType&&t.IdentityValue?{identityType:t.IdentityType,identityValue:t.IdentityValue}:null,campaignId:t.CampaignId,giftingInformation:null,optionalCampaignId:t.OptionalCampaignId,orderManagementPolityId:null,productId:t.ProductId,quantity:t.Quantity,renewalContext:null,setBlockInformation:null,skuId:t.SkuId}],language:t.Languages||t.Culture,market:t.Market,orderId:o(),orderState:"Purchased"};n.ajax({type:"POST",url:v(t.Environment,t.PurchaseServiceVersion),data:JSON.stringify(i),contentType:"application/json",beforeSend:function(n){n.setRequestHeader("MS-CV",t.CV);n.setRequestHeader("Authorization",t.Auth?'WLID1.0="'+t.Auth+'"':t.XToken)}}).then(function(i){var u=i&&n.isArray(i.orderLineItems)&&i.orderLineItems||[],r=u[0],e=r.purchaseRestriction&&r.purchaseRestriction.purchaseApprovalState&&r.purchaseRestriction.purchaseApprovalState.toLowerCase&&r.purchaseRestriction.purchaseApprovalState.toLowerCase(),s=r.parentalApprovalState&&r.parentalApprovalState.toLowerCase&&r.parentalApprovalState.toLowerCase();e==="blockedbypolicy"||e==="blockedbyage"||s==="blockedbypolicy"||s==="blockedbyage"?f(i.orderId,t.Auth,t.ParentElementId,t.Environment,t.Flight,t.ClientType,t.Culture,t.Market,t.CV,t.IframeOptions,t.PurchaseServiceVersion,t.Jwt,t.BeneficiaryData,t.Style,t.DeviceFamily,t.TestClient):window.postMessage(JSON.stringify({flowId:t.FlowId||o(),version:"1.0.0.1",message:"done",status:"success",data:{orderId:i.orderId,count:u.length,lineItems:u}}),"*")},function(n){var r=n&&n.responseJSON,u=r&&r.code&&r.code.toLowerCase&&r.code.toLowerCase();u==="forbidden"?f(i.orderId,t.Auth,t.ParentElementId,t.Environment,t.Flight,t.ClientType,t.Culture,t.Market,t.CV,t.IframeOptions,t.PurchaseServiceVersion,t.Jwt,t.BeneficiaryData,t.Style,t.DeviceFamily,t.TestClient):h(t)})},b=function(n,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt){var it={AvailabilityId:n,ProductId:r,SkuId:u,Quantity:g||1,Auth:e,Culture:l,Market:a,CV:v,IdentityType:y,IdentityValue:p,PurchaseServiceVersion:k,TestClient:tt||"",DeviceContext:"moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC"};f&&(it.CampaignId=f.campaignId||"",it.OptionalCampaignId=f.optionalCampaignId||"",it.OfferType=f.offerType||"");w&&(it.ProductType=w.productType||"",it.TransactionType=w.transactionType||"buy",it.Title=w.title||"",it.TitleNo=w.titleNo||"",it.SubTitle1=w.subTitle1||"",it.SubTitle2=w.subTitle2||"",it.ExpirationBeforePlayInHours=w.expirationBeforePlayInHours||"",it.ExpirationAfterPlayInHours=w.expirationAfterPlayInHours||"");i(it,d);t(it,o,s,h,c,"#/purchase/confirm",b,nt||"")},f=function(n,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){var k={OrderId:n,Auth:r,Culture:s,Market:h,CV:c,PurchaseServiceVersion:a,Jwt:v,TestClient:b||"",DeviceContext:"moId=PUBLIC&oemId=PUBLIC&scmId=PUBLIC"};y&&(k.BeneficiaryEmail=y.email,k.BeneficiaryFirstName=y.firstName||"",k.BeneficiaryLastName=y.lastName||"");i(k,p);t(k,u,f,e,o,"#/purchase/confirm",l,w||"")},k=function(n,r,u,f,e,o,s,h,c,l){var a={Auth:n,Culture:o,Market:s,CV:h,context:"primaryPi"};i(a,l);t(a,r,u,f,e,"#/paymentAndBilling/choosePaymentMethodFamily",c)},d=function(n,r,u,f,e,o,s,h,c,l,a){var v={Auth:n,Culture:o,Market:s,CV:h,PaymentInstrumentId:c};i(v,a);t(v,r,u,f,e,"#/paymentAndBilling/editPaymentInstrument",l)},g=function(n){var r={},u;n&&(r.Auth=n.Auth||"",r.XToken=n.XToken||"",r.Culture=n.Culture||"",r.Market=n.Market||"",r.CV=n.CV||"",r.context="primaryPi",r.PaymentMethodFamily=n.PaymentMethodFamily||"",r.PaymentMethodType=n.PaymentMethodType||"",r.BillableAccountId=n.BillableAccountId||"",r.PurchaseServiceVersion="7",r.Gamertag=n.Gamertag||"",r.GamerpicUrl=n.GamerpicUrl||"",u=n.DeviceFamily||"web",i(r,n.Style),t(r,n.ParentElementId,n.Environment,n.Flight,n.ClientType,"#/paymentAndBilling/choosePaymentMethodFamily",n.IframeOptions,u))},nt=function(n){var r={},u;n&&(r.Auth=n.Auth||"",r.XToken=n.XToken||"",r.Culture=n.Culture||"",r.Market=n.Market||"",r.CV=n.CV||"",r.PaymentInstrumentId=n.PaymentInstrumentId,r.PaymentMethodFamily=n.PaymentMethodFamily||"",r.PaymentMethodType=n.PaymentMethodType||"",r.PurchaseServiceVersion="7",u=n.DeviceFamily||"web",i(r,n.Style),t(r,n.ParentElementId,n.Environment,n.Flight,n.ClientType,"#/paymentAndBilling/editPaymentInstrument",n.IframeOptions,u))},tt=function(n){var r={},u;n&&(r.tokenString=n.TokenString||"",r.Auth=n.Auth||"",r.XToken=n.XToken||"",r.Culture=n.Culture||"",r.Market=n.Market||"",r.CV=n.CV||"",r.useDelegatedAuth=n.UseDelegatedAuth||!1,r.PurchaseServiceVersion=n.PurchaseServiceVersion||"7",r.UrlRef=n.UrlRef||"",r.EnableOcrScanLink=n.EnableOcrScanLink||"",u=n.DeviceFamily||"web",i(r,n.Style),t(r,n.ParentElementId,n.Environment,n.Flight,n.ClientType,"#/redeem/enterCode",n.IframeOptions,u))},it=function(n,r,u,f,e,o,s,h,c,l,a,v,y){var p={tokenString:n,Auth:r,Culture:s,Market:h,CV:c,PurchaseServiceVersion:"7",UrlRef:v,EnableOcrScanLink:y};i(p,a);t(p,u,f,e,o,"#/redeem/enterCode",l)},rt=function(n){for(var t=0;t<r.length;t++)if(""+r[t]==""+n){console.error("Same message handler function already registered: "+n);return}r.push(n)},ut=function(n){for(var t=0;t<r.length;t++)""+r[t]==""+n&&r.pop(n)};return{loadSingleItemPurchaseHtml:b,loadOrderPurchaseHtml:f,loadRedeemHtml:it,loadAddPaymentInstrumentHtml:k,loadEditPaymentInstrumentHtml:d,registerMessageHandler:rt,unregisterMessageHandler:ut,clientTypes:{UniversalWebStore:"UniversalWebStore",MusicVideoReading:"MusicVideoReading",EnterpriseStore:"EnterpriseStore",AccountMicrosoftCom:"AccountMicrosoftCom"},addPaymentInstrument:g,editPaymentInstrument:nt,purchaseSingleItem:h,purchaseFreeItem:w,redeem:tt,preLoadBlend:p}}(jQuery)